# Main CI/CD Pipeline
# Reusable workflows stored in ci/ directory, symlinked to .github/workflows/
# Referenced with version pinning for reproducibility
name: CI/CD Pipeline

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]

permissions: {}

jobs:
  # Stage 1: Run pre-commit hooks (catches skipped local checks)
  pre-commit:
    name: Pre-commit Checks
    uses: daniel-butler-irl/CoinNode/.github/workflows/pre-commit.yml@v0.4.0
    permissions:
      contents: read

  # Stage 2: Calculate next version (only on main branch)
  version:
    name: Calculate Version
    needs: [pre-commit]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      new_tag: ${{ steps.bump.outputs.new_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine version bump from commits
        id: bump
        run: |
          # Get the latest semver tag
          latest_tag=$(git tag -l 'v*.*.*' --sort=-v:refname | head -n1)

          if [ -z "$latest_tag" ]; then
            # No existing tags, start at v0.1.0
            echo "No existing tags, starting at v0.1.0"
            echo "new_tag=v0.1.0" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get commits since last tag
          commits=$(git log "${latest_tag}..HEAD" --pretty=format:"%s%n%b")

          # Determine bump type from conventional commits
          bump="patch"

          if echo "$commits" | grep -qiE "^BREAKING CHANGE:|^[a-z]+(\(.+\))?!:"; then
            bump="major"
          elif echo "$commits" | grep -qiE "^feat(\(.+\))?:"; then
            bump="minor"
          fi

          # Parse current version
          version=${latest_tag#v}
          IFS='.' read -r major minor patch <<< "$version"

          # Apply bump
          case $bump in
            major)
              major=$((major + 1))
              minor=0
              patch=0
              ;;
            minor)
              minor=$((minor + 1))
              patch=0
              ;;
            patch)
              patch=$((patch + 1))
              ;;
          esac

          new_tag="v${major}.${minor}.${patch}"

          echo "Latest tag: $latest_tag"
          echo "Bump type: $bump"
          echo "New tag: $new_tag"
          echo "new_tag=$new_tag" >> "$GITHUB_OUTPUT"

  # Stage 3: Build, scan, and push container image
  build:
    name: Build & Push
    needs: [pre-commit, version]
    if: |
      always() &&
      needs.pre-commit.result == 'success' &&
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    uses: daniel-butler-irl/CoinNode/.github/workflows/build.yml@v0.4.0
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
      security-events: write
      actions: read
    with:
      image_name: daniel-butler-irl/coinnode
      version: ${{ needs.version.outputs.new_tag }}

  # Stage 4: Create release (creates git tag via GitHub API)
  release:
    name: Release
    needs: [build, version]
    if: github.ref == 'refs/heads/main' && needs.build.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ needs.version.outputs.new_tag }}
        run: |
          echo "Creating release ${VERSION}"
          gh release create "${VERSION}" \
            --title "${VERSION}" \
            --generate-notes

  # Stage 5: Deploy and verify in ephemeral Kind cluster
  deploy-test:
    name: Deploy & Verify
    needs: [release, version]
    if: needs.release.result == 'success'
    uses: daniel-butler-irl/CoinNode/.github/workflows/cd-kind.yml@v0.4.0
    permissions:
      contents: read
      packages: read
    with:
      version: ${{ needs.version.outputs.new_tag }}
      verification_duration: 2
