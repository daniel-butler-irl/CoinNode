# Main CI/CD Pipeline
# Reusable workflows stored in ci/ directory, symlinked to .github/workflows/
# Referenced with version pinning for reproducibility
name: CI/CD Pipeline

on:
  push:
    branches: [main]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]

permissions: {}

jobs:
  # Stage 1: Run pre-commit hooks (catches skipped local checks)
  pre-commit:
    name: Pre-commit Checks
    uses: daniel-butler-irl/CoinNode/.github/workflows/pre-commit.yml@main
    permissions:
      contents: read

  # Stage 2: Build, scan, and push container image
  build:
    name: Build & Push
    needs: [pre-commit]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v'))
    uses: daniel-butler-irl/CoinNode/.github/workflows/build.yml@main
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
      security-events: write
      actions: read
    with:
      image_name: daniel-butler-irl/coinnode

  # Stage 3: Create release (only on version tags)
  release:
    name: Release
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v')
    uses: daniel-butler-irl/CoinNode/.github/workflows/release.yml@main
    permissions:
      contents: write
      attestations: write
      id-token: write
    with:
      image_name: daniel-butler-irl/coinnode
